<body>
	<script type="text/javascript" src="../lib/jQuery-1.9.1.js"></script>
	<script type="text/javascript" src="../lib/underscore-1.4.4.js"></script>
	<script type="text/javascript" src="../lib/Backbone-0.9.10.js"></script>
	<script type="text/javascript" src="../lib/WebMIDIAPI.js"></script>

	<script type="text/javascript" src="audio.io.js"></script>
	<script type="text/javascript" src="audio.io.utils.js"></script>
	<script type="text/javascript" src="audio.io.Pool.js"></script>

	<script type="text/javascript" src="audio.io.Node.js"></script>
	<script type="text/javascript" src="audio.io.Audio.js"></script>
	<script type="text/javascript" src="audio.io.Input.js"></script>

	<script type="text/javascript" src="audio.io.Analyser.js"></script>
	<script type="text/javascript" src="audio.io.Effects.js"></script>
	<script type="text/javascript" src="audio.io.Envelope.js"></script>
	<script type="text/javascript" src="audio.io.Keyboard.js"></script>
	<script type="text/javascript" src="audio.io.LFO.js"></script>
	<script type="text/javascript" src="audio.io.MIDI.js"></script>
	<script type="text/javascript" src="audio.io.Oscillator.js"></script>
	<script type="text/javascript" src="audio.io.StereoPanPot.js"></script>
	<script type="text/javascript" src="audio.io.VolumeControl.js"></script>


	<canvas id="canvas" width="500" height="250"></canvas>

	<script type="text/javascript">
		audio.io.initialize();


		var volume = new audio.io.VolumeControl({
			value: 90
		});


		var panPot = new audio.io.StereoPanPot({
			value: 0
		});


		var osc = new audio.io.Oscillator({
			type: 1,
			polyphony: 16,
			numVoices: 3,
			detune: 10
		});

		var stringSim = new audio.io.StringSim({
			bufferSize: 2048,
			impulseLength: 0.1,
			active: 1,
			frequency: 440,
			damping: 2
		});

		// osc.connectMod(lfo, 'detune');
		// lfo.connectMod(lfo, 'depth');

		var keyboard = new audio.io.Keyboard();
		keyboard.on('noteOn', function(channel, frequency, velocity) {
			if(velocity !== 0) {
				osc.start(frequency, velocity);
				stringSim.set('frequency', frequency);
			}
			else {
				osc.stop(frequency, velocity);
			}
		});


		var midi = new audio.io.MIDI({
			channel: 1
		});
		midi.on('noteOn', function(channel, frequency, velocity) {
			if(velocity !== 0) {
				osc.start(frequency, velocity);
				stringSim.set('frequency', frequency);
			}
			else {
				osc.stop(frequency, velocity);
			}
		});

		// var flanger = new audio.io.Flanger({
		// 	delay: 0.001,
		// 	poles: 2,
		// 	frequency: 100,
		// 	feedback: 0.9,
		// 	lfoRate: 3,
		// 	lfoDepth: 0.01,
		// 	dryWet: 0
		// });

		var comb = new audio.io.CombFilter({
			frequency: 500,
			damping: 0.7,
			feedback: 0.9,
			Q: 1,
			delay: 0.03
		});


		audio.io.utils.loadFileIntoBuffer('../impulses/impulse_rev.wav', function(buffer) {
			var bufferSource = audio.io.context.createBufferSource();
			bufferSource.buffer = buffer;
			bufferSource.connect(audio.io.masterOut);
			bufferSource.start(1);

			var canvas = document.querySelector('#canvas'),
				ctx = canvas.getContext('2d'),
				width = canvas.width,
				height = canvas.height,
				bufferData = buffer.getChannelData(0),
				stepSize = width / bufferData.length,
				middleY = height/2 | 0,
				max = 0,
				start = Date.now();


			// Draw a sample-based waveform.
			ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
			ctx.beginPath();
			ctx.moveTo(0, middleY);

			for(var i = 0; i < bufferData.length; ++i) {
				max = Math.max(max, Math.abs(bufferData[i]));
			}

			var scaled = middleY / max;

			for(var i = 0; i < bufferData.length; ++i) {
				ctx.lineTo(i * stepSize, middleY - scaled * bufferData[i]);
			}

			ctx.closePath();
			ctx.stroke();


			// Draw a pixel-based waveform.
			// stepSize = bufferData.length / width;
			// ctx.strokeStyle = 'rgba(255, 255, 255, 1)';

			// ctx.beginPath();
			// ctx.moveTo(0, middleY);

			// for(var i = 0; i < width; ++i) {
			// 	max = Math.max(max, bufferData[i * stepSize | 0]);
			// }


			// var scaled = middleY / max;

			// for(var i = 0; i < width; ++i) {
			// 	ctx.lineTo(i,  middleY - scaled * bufferData[i * stepSize | 0]);
			// }

			// ctx.closePath();
			// ctx.stroke();
		});



		// stringSim.connectTo(comb)
		// 	.connectTo(panPot)
		// 	.connectTo(volume)
		// 	.connectTo(audio.io.masterOut);

	</script>
</body>